%%%%%%%%%%%%%%%%%%
% Main functions %
% ============== %
%%%%%%%%%%%%%%%%%%
function IntensityAverage(varargin)
	
	% Load data struct
	data = guidata(findobj('Tag','hSMAT'));
	
	% Dimensions
	ah = 220;
	aw = 640;
	
	brh = 47;
	
	bw = 80;
	bh = 25;
	
	ew = 50;
	eh = 25;
	
	tw = 80;
	th = 20;
	
	x1 = 30;
	x2 = x1 + aw + 30;
		
	y1 = brh + 10;
	y2 = y1 + 4*th + 10;
	y3 = y2 + ah + 10;
	
	w = 40 + aw + 40;
	h = brh + 10 + 4*th + 10 + ah + 10 + th + 20;
	
	% Figure
	hFig = figure(...
	  	'Units','pixels',...
		'MenuBar','none',...
		'Toolbar','none',...
		'NumberTitle','off',...
		'Visible','off',...
		'Position',[0 0 w h],...
		'Resize','off',...
		'Name','ATT - Intensity Average');
	
	% Button row
	hButtonPanel = uibuttongroup(...
		'Parent',hFig,...
		'Tag','MainGUI_ButtonPane',...
		'Units','pixels',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'visible','on',...
		'BorderType','none',...
		'Position',[x1 0 w-20 brh]);
	
	uicontrol(...
		'Parent',hButtonPanel,...
		'Units','pixels',...
		'Style','pushbutton',...
		'String','Close',...
		'Position',[w-20-(bw+30) 10 bw bh],...
		'Callback',{@CloseFig,hFig});
	
	% Plot axes
	hAxes = axes(...
		'Parent',hFig,...
		'Units','pixels',...
		'Position',[x1+10 y2 aw ah],...
		'Visible','on');
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','center',...
		'Units','pixels',...
		'FontSize',12,...
		'String','Intensity average over stretched molecule',...
	   'Position',[x1+10 y3 aw th]);
	axis(hAxes,'on',[1 200 0 1])
	
	% Get Data
	map = data.tme.currentTT;
	Lx = data.tme.moleculeLength';
	x0 = data.tme.moleculeCenter';
	nFrames = data.tme.nFrames;
	yInt = data.tme.intLim(3:4);
	
	% Calc. params.
	sel = round([x0-Lx./2 x0+Lx./2]);
	s = round(max(Lx));
	
	% Debug
	if false

		debug.map = map;
		debug.minMap = min(min(map));
		debug.maxMap = max(max(map));
		debug.Lx = Lx;
		debug.x0 = x0;
		debug.nFrames = nFrames;
		debug.meanSize = mean(Lx);
		debug.minLx = min(Lx);
		debug.maxLx = max(Lx);
		debug.minx0 = min(x0);
		debug.maxx0 = max(x0);
		debug.sel = sel;
		debug.s = s;
		
		disp(debug)

	end
	
	% Cut trace from map
	for i = 1 : nFrames
		
		intensityMap(i,:) = stretchSelection(map(i,:),sel(i,:),s);
		
	end
	
	% Average intensity
	intensity = mean(intensityMap,1);
	stdVals = std(intensityMap,1);
	xVals = 1:(length(intensity));
	
	% Plot data
	plot(hAxes,...
		xVals,intensity,'k',...
		xVals,intensity-stdVals,'--r',...
		xVals,intensity+stdVals,'--r');
	legend(hAxes,'Mean','Std','Location','best');
	axis(hAxes,[1 xVals(end) min(map(1,:)) max(intensity+stdVals)],'on')
	set(hAxes,'YTick',[]);
	set(hAxes,'XTick',[]);
	
	
	% Display data labels
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','left',...
		'Units','pixels',...
		'FontSize',10,...
		'String','Mean length:',...
	   'Position',[x1 y1+2*th 150 th]);
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','left',...
		'Units','pixels',...
		'FontSize',10,...
		'String',sprintf('%0.3g pixels',mean(Lx)),...
	   'Position',[x1+150 y1+2*th aw th]);
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','left',...
		'Units','pixels',...
		'FontSize',10,...
		'String','Mean std:',...
	   'Position',[x1 y1+th 150 th]);
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','left',...
		'Units','pixels',...
		'FontSize',10,...
		'String',sprintf('%0.3g [rel.]',mean(stdVals)),...
	   'Position',[x1+150 y1+th aw th]);
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','left',...
		'Units','pixels',...
		'FontSize',10,...
		'String','Max/Min Intensity:',...
	   'Position',[x1 y1 150 th]);
	uicontrol(...
		'Parent',hFig,...
		'Style','text',...
		'BackgroundColor',get(findobj('Tag','hTME'),'Color'),...
		'HorizontalAlignment','left',...
		'Units','pixels',...
		'FontSize',10,...
		'String',sprintf('%0.3g / %0.3g',max(intensity),min(intensity)),...
	   'Position',[x1+150 y1 aw th]);
	
	% Move and make visible.
	movegui(hFig,'north')
	set(hFig,'Visible','on');

end

%%%%%%%%%%%%%%%%%%%%%%
% Callback functions %
% ================== %
%%%%%%%%%%%%%%%%%%%%%%
function CloseFig(hObject,handles,varargin)
	
	close(varargin{1:end});
	
end
	
	
%%%%%%%%%%%%%%%%%%%
% Other functions %
% =============== %
%%%%%%%%%%%%%%%%%%%
function Y = stretchSelection(X,sel,s)
	
	% Adjust edges to within map
	if (sel(1) < 2)
		sel(1) = 2;
	end
	if (sel(2) > length(X) - 1)
		sel(2) = length(X) - 1;
	end
	
	% Get molecule
	m = X(sel(1):sel(2));

	% Stretch molecule
	Y = imresize(m,[1 s],'nearest');
		
end
